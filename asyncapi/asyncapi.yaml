asyncapi: 3.0.0
info:
  title: Synapse Event Pipeline
  version: 1.0.0
  description: |
    Synapse is a real-time data enrichment and routing platform.
    It ingests events, processes them through configurable pipeline stages,
    and routes them to subscribers based on rules and filters.
  contact:
    name: Synapse Team
  license:
    name: MIT

defaultContentType: application/json

servers:
  nats-local:
    host: localhost:4222
    protocol: nats
    description: Local NATS server for development
  nats-test:
    host: nats:4222
    protocol: nats
    description: NATS in testcontainers

channels:
  orders/ingest:
    address: orders.ingest
    description: Raw incoming orders from external sources
    servers:
      - $ref: '#/servers/nats-local'
      - $ref: '#/servers/nats-test'
    messages:
      orderReceived:
        $ref: '#/components/messages/OrderReceived'

  orders/validated:
    address: orders.validated
    description: Orders that have passed validation
    servers:
      - $ref: '#/servers/nats-local'
      - $ref: '#/servers/nats-test'
    messages:
      orderValidated:
        $ref: '#/components/messages/OrderValidated'

  orders/enriched:
    address: orders.enriched
    description: Orders enriched with customer and fraud data
    servers:
      - $ref: '#/servers/nats-local'
      - $ref: '#/servers/nats-test'
    messages:
      orderEnriched:
        $ref: '#/components/messages/OrderEnriched'

  orders/routed:
    address: orders.routed.{destination}
    description: Final routing destination for orders
    servers:
      - $ref: '#/servers/nats-local'
      - $ref: '#/servers/nats-test'
    parameters:
      destination:
        description: Routing destination
        enum:
          - fulfillment
          - manual-review
          - rejected
    messages:
      orderRouted:
        $ref: '#/components/messages/OrderRouted'

  orders/dlq:
    address: orders.dlq
    description: Dead letter queue for failed orders
    servers:
      - $ref: '#/servers/nats-local'
      - $ref: '#/servers/nats-test'
    messages:
      orderFailed:
        $ref: '#/components/messages/OrderFailed'

  pipeline/stage-complete:
    address: pipeline.stage.{stageId}.complete
    description: Emitted when a pipeline stage completes
    servers:
      - $ref: '#/servers/nats-local'
      - $ref: '#/servers/nats-test'
    parameters:
      stageId:
        enum: [validate, enrich-customer, enrich-inventory, fraud-check, route]
    messages:
      stageComplete:
        $ref: '#/components/messages/StageComplete'

  pipeline/errors:
    address: pipeline.errors
    description: Centralized error channel
    servers:
      - $ref: '#/servers/nats-local'
      - $ref: '#/servers/nats-test'
    messages:
      pipelineError:
        $ref: '#/components/messages/PipelineError'

operations:
  ingestOrder:
    action: send
    channel:
      $ref: '#/channels/orders~1ingest'
    summary: Publish a new order to the ingest channel

  validateOrder:
    action: receive
    channel:
      $ref: '#/channels/orders~1ingest'
    summary: Consume orders for validation

  enrichOrder:
    action: receive
    channel:
      $ref: '#/channels/orders~1validated'
    summary: Consume validated orders for enrichment

  routeOrder:
    action: receive
    channel:
      $ref: '#/channels/orders~1enriched'
    summary: Consume enriched orders for routing

  consumeFulfillment:
    action: receive
    channel:
      $ref: '#/channels/orders~1routed'
    summary: Consume orders routed to fulfillment

  consumeDLQ:
    action: receive
    channel:
      $ref: '#/channels/orders~1dlq'
    summary: Consume failed orders from DLQ

components:
  messages:
    OrderReceived:
      name: OrderReceived
      title: Order Received Event
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CommonHeaders'
      payload:
        $ref: '#/components/schemas/OrderReceivedPayload'

    OrderValidated:
      name: OrderValidated
      title: Order Validated Event
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CommonHeaders'
      payload:
        $ref: '#/components/schemas/OrderValidatedPayload'

    OrderEnriched:
      name: OrderEnriched
      title: Order Enriched Event
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CommonHeaders'
      payload:
        $ref: '#/components/schemas/OrderEnrichedPayload'

    OrderRouted:
      name: OrderRouted
      title: Order Routed Event
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CommonHeaders'
      payload:
        $ref: '#/components/schemas/OrderRoutedPayload'

    OrderFailed:
      name: OrderFailed
      title: Order Failed Event
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CommonHeaders'
      payload:
        $ref: '#/components/schemas/OrderFailedPayload'

    StageComplete:
      name: StageComplete
      title: Pipeline Stage Complete
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CommonHeaders'
      payload:
        $ref: '#/components/schemas/StageCompletePayload'

    PipelineError:
      name: PipelineError
      title: Pipeline Error Event
      contentType: application/json
      headers:
        $ref: '#/components/schemas/CommonHeaders'
      payload:
        $ref: '#/components/schemas/PipelineErrorPayload'

  schemas:
    CommonHeaders:
      type: object
      required: [correlationId, timestamp, source]
      properties:
        correlationId:
          type: string
          format: uuid
        timestamp:
          type: string
          format: date-time
        source:
          type: string
        traceId:
          type: string
        spanId:
          type: string

    OrderReceivedPayload:
      type: object
      required: [orderId, customerId, items, totalAmount, currency, createdAt]
      properties:
        orderId:
          type: string
          format: uuid
        customerId:
          type: string
          format: uuid
        items:
          type: array
          items:
            $ref: '#/components/schemas/OrderItem'
        totalAmount:
          type: number
        currency:
          type: string
        shippingAddress:
          $ref: '#/components/schemas/Address'
        createdAt:
          type: string
          format: date-time

    OrderValidatedPayload:
      allOf:
        - $ref: '#/components/schemas/OrderReceivedPayload'
        - type: object
          properties:
            validatedAt:
              type: string
              format: date-time
            validationResult:
              type: object
              properties:
                isValid:
                  type: boolean
                warnings:
                  type: array
                  items:
                    type: string

    OrderEnrichedPayload:
      allOf:
        - $ref: '#/components/schemas/OrderValidatedPayload'
        - type: object
          properties:
            enrichedAt:
              type: string
              format: date-time
            customer:
              $ref: '#/components/schemas/CustomerData'
            fraudScore:
              $ref: '#/components/schemas/FraudScore'

    OrderRoutedPayload:
      allOf:
        - $ref: '#/components/schemas/OrderEnrichedPayload'
        - type: object
          properties:
            routedAt:
              type: string
              format: date-time
            destination:
              type: string
              enum: [fulfillment, manual-review, rejected]
            routingReason:
              type: string

    OrderFailedPayload:
      type: object
      required: [orderId, failedAt, failureStage, error, retryCount]
      properties:
        orderId:
          type: string
          format: uuid
        originalPayload:
          type: object
        failedAt:
          type: string
          format: date-time
        failureStage:
          type: string
        error:
          type: object
          properties:
            code:
              type: string
            message:
              type: string
        retryCount:
          type: integer

    StageCompletePayload:
      type: object
      required: [stageId, eventId, durationMs, status]
      properties:
        stageId:
          type: string
        eventId:
          type: string
          format: uuid
        durationMs:
          type: integer
        status:
          type: string
          enum: [success, skipped, retry]

    PipelineErrorPayload:
      type: object
      required: [errorId, eventId, stageId, errorType, message, timestamp]
      properties:
        errorId:
          type: string
          format: uuid
        eventId:
          type: string
          format: uuid
        stageId:
          type: string
        errorType:
          type: string
          enum: [validation, enrichment, timeout, external-service, unknown]
        message:
          type: string
        retryCount:
          type: integer
        timestamp:
          type: string
          format: date-time

    OrderItem:
      type: object
      required: [sku, quantity, unitPrice]
      properties:
        sku:
          type: string
        productName:
          type: string
        quantity:
          type: integer
          minimum: 1
        unitPrice:
          type: number

    Address:
      type: object
      required: [street, city, country]
      properties:
        street:
          type: string
        city:
          type: string
        state:
          type: string
        postalCode:
          type: string
        country:
          type: string

    CustomerData:
      type: object
      properties:
        customerId:
          type: string
          format: uuid
        tier:
          type: string
          enum: [bronze, silver, gold, platinum]
        accountAge:
          type: integer
        lifetimeValue:
          type: number

    FraudScore:
      type: object
      properties:
        score:
          type: number
          minimum: 0
          maximum: 100
        riskLevel:
          type: string
          enum: [low, medium, high, critical]
        signals:
          type: array
          items:
            type: string
